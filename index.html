<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Generador de Etiquetas con Previsualización</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background-color: #f4f7f9;
      color: #333;
      margin: 0;
      padding: 2rem;
    }
    .main-container {
      display: flex;
      gap: 30px;
      max-width: 1000px;
      margin: auto;
      align-items: flex-start;
    }
    .controls-panel, .preview-panel {
      background-color: #ffffff;
      padding: 25px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
    }
    .controls-panel { flex: 1; }
    .preview-panel { flex: 1; }
    h2 { text-align: center; color: #2c3e50; margin-bottom: 30px; }
    label { font-weight: 500; display: block; margin-bottom: 6px; }
    input[type="text"], input[type="number"], input[type="file"] {
      width: 100%;
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #dcdcdc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .size-inputs { display: flex; gap: 10px; }
    #generarPDF {
      width: 100%;
      padding: 12px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      margin-top: 10px;
      transition: background-color 0.2s ease-in-out;
    }
    #generarPDF:hover { background-color: #0056b3; }
    #previewContainer { border-color: #e0e0e0; }
  </style>
</head>
<body>
  <h2>Generador de Etiquetas</h2>
  <div class="main-container">
    <div class="controls-panel">
      <div>
        <label for="etiquetaAncho">1. Define la proporción de la etiqueta (en cm):</label>
        <div class="size-inputs">
          <input type="number" id="etiquetaAncho" placeholder="Ancho (cm)" value="4">
          <input type="number" id="etiquetaAlto" placeholder="Alto (cm)" value="6">
        </div>
      </div>
      <div>
        <label for="nombreProducto">2. Escribe el texto para la etiqueta:</label>
        <input type="text" id="nombreProducto" placeholder="Nombre del producto" autocomplete="off">
      </div>
      <div>
        <label for="fontSize">3. Tamaño de la fuente (puntos):</label>
        <input type="number" id="fontSize" value="10">
      </div>
      <button id="generarPDF">Generar PDF</button>
    </div>
    <div class="preview-panel">
      <label>4. Previsualización:</label>
      <div id="previewContainer" style="border: 1px solid #ccc; padding: 1px; min-height: 400px; margin-top: 5px; display: flex; justify-content: center; align-items: center; background-color: #f9f9f9; border-radius: 5px;">
        <div id="previewEtiqueta" style="background-size: contain; background-repeat: no-repeat; background-position: center; display: flex; flex-direction: column; justify-content: flex-end; text-align: center; color: black; font-weight: bold; overflow: hidden; flex-shrink: 0;">
          <div id="previewTextoContainer" style="padding: 5px;"></div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://unpkg.com/pdf-lib/dist/pdf-lib.min.js"></script>
  <script>
    // Define aquí el nombre de tu imagen base. Debe estar en la misma carpeta.
    const RUTA_IMAGEN_BASE = 'etiqueta-base.jpg';
    // --- FUNCIÓN REUTILIZABLE PARA AJUSTE DE TEXTO ---
    function calculateLines(text, font, fontSize, maxWidth) {
      const words = text.split(' ');
      const lines = [];
      let currentLine = '';

      for (const word of words) {
        const testLine = currentLine === '' ? word : `${currentLine} ${word}`;
        // Usamos una función de medición que pasamos como argumento
        if (font.widthOfTextAtSize(testLine, fontSize) <= maxWidth) {
          currentLine = testLine;
        } else {
          if (currentLine !== '') lines.push(currentLine);
          currentLine = word;
        }
      }
      lines.push(currentLine);
      return lines;
    }

    function calculateFinalDimensions(anchoCm, altoCm) {
        const pageWidth = 612; // Letter width in points
        const MARGEN = 36;

        const areaUtilAncho = pageWidth - (2 * MARGEN);
        const columnas = 5;
        const GAP_HORIZONTAL = 5; // Puntos de espacio entre etiquetas

        const etiquetaAnchoPt = (areaUtilAncho - (GAP_HORIZONTAL * (columnas - 1))) / columnas;
        
        if (anchoCm <= 0 || altoCm <= 0) {
            return { etiquetaAnchoPt, etiquetaAltoPt: 0 };
        }
        const aspectRatio = anchoCm / altoCm;
        const etiquetaAltoPt = etiquetaAnchoPt / aspectRatio;

        return { etiquetaAnchoPt, etiquetaAltoPt };
    }
    document.getElementById("generarPDF").addEventListener("click", async () => {
      try {
        // --- 1. OBTENER DATOS DEL USUARIO ---
        const nombre = document.getElementById("nombreProducto").value.trim();
        const etiquetaAnchoCM = parseFloat(document.getElementById("etiquetaAncho").value);
        const etiquetaAltoCM = parseFloat(document.getElementById("etiquetaAlto").value);
        const fontSize = parseInt(document.getElementById("fontSize").value);

        if (!nombre || !etiquetaAnchoCM || !etiquetaAltoCM) {
          alert("Por favor, completa todos los campos: define la proporción y escribe un nombre.");
          return;
        }

        // --- 2. PREPARAR EL DOCUMENTO PDF Y LOS RECURSOS ---
        const pdfDoc = await PDFLib.PDFDocument.create();
        const page = pdfDoc.addPage(PDFLib.PageSizes.Letter); // Hoja tamaño carta
        const { width: pageWidth, height: pageHeight } = page.getSize();

        // Cargar la imagen base desde el programa
        const imagenBytes = await fetch(RUTA_IMAGEN_BASE).then(res => {
            if (!res.ok) throw new Error(`No se pudo cargar la imagen base: ${RUTA_IMAGEN_BASE}. Asegúrate de que el archivo existe en la misma carpeta.`);
            return res.arrayBuffer();
        });
        let imagenEmbed;
        if (RUTA_IMAGEN_BASE.toLowerCase().endsWith(".png")) {
          imagenEmbed = await pdfDoc.embedPng(imagenBytes);
        } else {
          imagenEmbed = await pdfDoc.embedJpg(imagenBytes);
        }

        // Cargar la fuente para el texto
        const font = await pdfDoc.embedFont(PDFLib.StandardFonts.HelveticaBold);

        // --- 3. CALCULAR DISEÑO DE LA PÁGINA (GRID) USANDO LAS MEDIDAS DEL USUARIO ---
        const MARGEN = 36; // 0.5 pulgadas de margen (72 puntos = 1 pulgada)
        
        // Se calcula el tamaño final para que quepan 5 columnas
        const { etiquetaAnchoPt: etiquetaAncho, etiquetaAltoPt: etiquetaAlto } = calculateFinalDimensions(etiquetaAnchoCM, etiquetaAltoCM);
        
        const areaUtilAncho = pageWidth - (2 * MARGEN);
        const areaUtilAlto = pageHeight - (2 * MARGEN);

        const columnas = 5; // Forzado a 5 columnas
        const filas = Math.floor(areaUtilAlto / etiquetaAlto);

        // Calcular espaciado para distribuir uniformemente las etiquetas
        const espacioHorizontal = 5; // El mismo gap usado en el cálculo
        const espacioVertical = filas > 1 ? (areaUtilAlto - (filas * etiquetaAlto)) / (filas - 1) : 0;

        // --- 4. AJUSTAR TEXTO SEGÚN TAMAÑO DE FUENTE DEL USUARIO ---
        const lines = calculateLines(nombre, font, fontSize, etiquetaAncho - 10);

        // --- 5. DIBUJAR LAS ETIQUETAS EN BUCLE ---
        for (let i = 0; i < filas; i++) {
          for (let j = 0; j < columnas; j++) {
            // Posición de la esquina inferior izquierda de la imagen
            const posX = MARGEN + j * (etiquetaAncho + espacioHorizontal);
            const posY = pageHeight - MARGEN - etiquetaAlto - i * (etiquetaAlto + espacioVertical);

            page.drawImage(imagenEmbed, { x: posX, y: posY, width: etiquetaAncho, height: etiquetaAlto });

            // --- Lógica de Posicionamiento Vertical (Alineado desde Abajo) ---
            const lineHeight = fontSize * 1.2;
            const totalTextHeight = (lines.length - 1) * lineHeight;
            const textBottomMargin = 5; // Puntos desde el borde inferior de la etiqueta.

            // Calcula la posición Y de la PRIMERA línea, basándose en la posición inferior.
            const startY = posY + textBottomMargin + totalTextHeight;

            for (const [index, line] of lines.entries()) {
              const textWidth = font.widthOfTextAtSize(line, fontSize);
              const textX = posX + (etiquetaAncho - textWidth) / 2; // Centrar cada línea horizontalmente
              const textY = startY - (index * lineHeight);

              page.drawText(line, { x: textX, y: textY, font, size: fontSize, color: PDFLib.rgb(0, 0, 0) });
            }
          }
        }

        // --- 5. GUARDAR Y DESCARGAR EL PDF ---
        const pdfBytes = await pdfDoc.save();
        const blob = new Blob([pdfBytes], { type: "application/pdf" });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = `etiquetas_${nombre.replace(/ /g, "_")}.pdf`;
        link.click();
        URL.revokeObjectURL(link.href); // Buena práctica para liberar memoria
      } catch (error) {
        console.error("Ocurrió un error al generar el PDF:", error);
        alert("No se pudo generar el PDF. Revisa la consola para más detalles.");
      }
    });

    // --- LÓGICA DE PREVISUALIZACIÓN ---
    const anchoInput = document.getElementById("etiquetaAncho");
    const altoInput = document.getElementById("etiquetaAlto");
    const nombreInput = document.getElementById("nombreProducto");
    const fontSizeInput = document.getElementById("fontSize");

    const previewEtiqueta = document.getElementById("previewEtiqueta");
    const previewTextoContainer = document.getElementById("previewTextoContainer");

    function updatePreview() {
      const anchoCm = parseFloat(anchoInput.value) || 0;
      const altoCm = parseFloat(altoInput.value) || 0;
      const nombre = nombreInput.value;
      const fontSizePt = parseInt(fontSizeInput.value) || 10;

      // Calcular el tamaño final que tendrá en el PDF para que la previsualización sea fiel
      const { etiquetaAnchoPt, etiquetaAltoPt } = calculateFinalDimensions(anchoCm, altoCm);

      // Convertir las dimensiones finales de puntos a píxeles
      const PUNTOS_POR_CM = 28.346;
      const dpi = 96; // DPI estándar de pantalla
      const finalAnchoCm = etiquetaAnchoPt / PUNTOS_POR_CM;
      const finalAltoCm = etiquetaAltoPt / PUNTOS_POR_CM;
      const previewWidth = finalAnchoCm * dpi / 2.54;
      const previewHeight = finalAltoCm * dpi / 2.54;

      // Añadimos un factor de escala para que la previsualización sea más grande y cómoda de ver.
      const PREVIEW_SCALE_FACTOR = 1.25;

      previewEtiqueta.style.width = `${previewWidth * PREVIEW_SCALE_FACTOR}px`;
      previewEtiqueta.style.height = `${previewHeight * PREVIEW_SCALE_FACTOR}px`;
      
      // Simular la posición del texto usando CSS
      const textBottomMargin = 5; // Debe coincidir con el valor en el generador de PDF
      previewEtiqueta.style.paddingBottom = `${textBottomMargin}px`;

      // Limpiar texto anterior y añadir el nuevo
      previewTextoContainer.innerHTML = '';
      previewTextoContainer.style.fontSize = `${fontSizePt}pt`;
      previewTextoContainer.innerText = nombre; // El navegador se encarga del ajuste de texto aquí

      // Cargar la imagen base en la previsualización
      previewEtiqueta.style.backgroundImage = `url('${RUTA_IMAGEN_BASE}')`;
    }

    [anchoInput, altoInput, nombreInput, fontSizeInput].forEach(input => {
      input.addEventListener('input', updatePreview);
    });

    updatePreview(); // Llamada inicial para establecer el estado
  </script>

</body>
</html>
